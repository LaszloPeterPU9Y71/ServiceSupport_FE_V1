<div class="container mt-4">
  <h3 class="mb-3">Javításra beadott gépek</h3>

  @if (saveError()) {
    <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center justify-content-between mt-3" role="alert">
      <div class="me-2">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ "Hiba történt a gép mentése közben" }}
      </div>
      <button type="button" class="btn-close" aria-label="Bezárás" (click)="saveError.set(false)"></button>
    </div>
  }

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white">Új eszköz felvétele</div>

    <div class="card-body">
      <form (ngSubmit)="createTool()" #toolForm="ngForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Megnevezés</label>
          <input class="form-control"
                 name="name"
                 required
                 [(ngModel)]="newTool.name" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Típusszám</label>
          <input class="form-control"
                 name="typeNumber"
                 [(ngModel)]="newTool.typeNumber" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Cikkszám</label>
          <input class="form-control"
                 name="itemNumber"
                 [(ngModel)]="newTool.itemNumber" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Sorszám</label>
          <input class="form-control"
                 name="serialNumber"
                 [(ngModel)]="newTool.serialNumber" />
        </div>

        <div class="col-md-4">
          <label class="form-label">Behozta</label>
          <select class="form-select"
                  name="owner"
                  required
                  [(ngModel)]="newTool.owner">
            <option [ngValue]="undefined" disabled selected>Válassz...</option>

            @for (c of customers(); track c.id) {
              <option [ngValue]="c">
                {{ c.name }}
                @if (c.ownerCompanyName) {
                  ({{ c.ownerCompanyName }})
                }
              </option>
            } @empty {
              <option [ngValue]="undefined" disabled>Nincs ügyfél</option>
            }
          </select>
        </div>

        <div class="col-12 d-flex align-items-center gap-2 flex-wrap">
          <button class="btn btn-primary"
                  type="submit"
                  [disabled]="toolForm.invalid || isSaving()">
            {{ isSaving() ? 'Mentés...' : 'Hozzáadás' }}
          </button>

          <button class="btn btn-secondary"
                  type="button"
                  (click)="resetForm()"
                  [disabled]="isSaving()">
            Mégse
          </button>

          @if (saveSuccess()) {
            <span class="text-success">✔ Sikeresen hozzáadva</span>
          }

        </div>
      </form>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle text-center">
      <thead class="table-dark">
      <tr>
        <th>Megnevezés</th>
        <th>Típusszám</th>
        <th>Cikkszám</th>
        <th>Sorszám</th>
        <th>Behozta</th>
        <th>Cég neve</th>
        <th>Műveletek</th>
      </tr>
      <tr>
        <th>
          <input class="form-control"
                 [ngModel]="filters()['name']"
                 (ngModelChange)="updateFilter('name', $event)"
                 placeholder="Keresés..." />
        </th>
        <th>
          <input class="form-control"
                 [ngModel]="filters()['typeNumber']"
                 (ngModelChange)="updateFilter('typeNumber', $event)"
                 placeholder="Keresés..." />
        </th>
        <th>
          <input class="form-control"
                 [ngModel]="filters()['itemNumber']"
                 (ngModelChange)="updateFilter('itemNumber', $event)"
                 placeholder="Keresés..." />
        </th>
        <th>
          <input class="form-control"
                 [ngModel]="filters()['serialNumber']"
                 (ngModelChange)="updateFilter('serialNumber', $event)"
                 placeholder="Keresés..." />
        </th>
        <th>
          <input class="form-control"
                 [ngModel]="filters()['ownerName']"
                 (ngModelChange)="updateFilter('ownerName', $event)"
                 placeholder="Keresés..." />
        </th>
        <th>
          <input class="form-control"
                 [ngModel]="filters()['ownerCompanyName']"
                 (ngModelChange)="updateFilter('ownerCompanyName', $event)"
                 placeholder="Keresés..." />
        </th>
        <th></th>
      </tr>


      </thead>

      <tbody>
        @for (tool of filteredTools(); track tool.id) {
          <tr>
            @if (editingTool() && editingTool()?.id === tool.id) {
              <!-- Szerkesztő mezők -->
              <td><input class="form-control" [(ngModel)]="editingTool()!.name" /></td>
              <td><input class="form-control" [(ngModel)]="editingTool()!.typeNumber" /></td>
              <td><input class="form-control" [(ngModel)]="editingTool()!.itemNumber" /></td>
              <td><input class="form-control" [(ngModel)]="editingTool()!.serialNumber" /></td>
              <td></td>
              <td></td>

              <td class="d-flex gap-2 justify-content-center">
                <button class="btn btn-primary btn-sm" (click)="saveEdit()">Mentés</button>
                <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">Mégse</button>
              </td>
            } @else {
              <!-- Normál sor -->
              <td>{{ tool.name }}</td>
              <td>{{ tool.typeNumber }}</td>
              <td>{{ tool.itemNumber }}</td>
              <td>{{ tool.serialNumber }}</td>
              <td>{{ tool.ownerName }}</td>
              <td>{{ tool.ownerCompanyName }}</td>
              <td>
                <button class="btn btn-warning btn-sm me-2" (click)="editTool(tool)">Szerkesztés</button>
              </td>
            }
          </tr>
        } @empty {
          <tr>
            <td colspan="7" class="text-muted text-center">Nincs találat</td>
          </tr>
        }
      </tbody>
    </table>>
  </div>
</div>
