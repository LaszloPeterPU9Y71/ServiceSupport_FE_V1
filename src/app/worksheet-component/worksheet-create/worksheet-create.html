<div class="container mt-4">
  <h3 class="mb-3">Javítási munkalap létrehozása</h3>

  <table class="table table-bordered align-middle mt-3">
    <tbody>
    <!-- Gép kiválasztás -->
    <tr>
      <th style="width: 25%">Gép</th>
      <td class="position-relative">
        <button class="form-select text-start"
                type="button"
                (click)="dropdownOpen.set(!dropdownOpen())">
          {{ getToolDisplayName(formData().toolId) || 'Válassz gépet...' }}
        </button>

        @if (dropdownOpen()) {
          <div class="dropdown-menu show w-100 mt-1 p-0 shadow"
               style="max-height: 300px; overflow-y: auto; z-index: 1050;">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-light sticky-top">
              <tr>
                <th>Megnevezés</th>
                <th>Típus szám</th>
                <th>Sorszám</th>
                <th>Cikkszám</th>
                <th>Tulajdonos</th>
                <th>Email</th>
              </tr>
              </thead>
              <tbody>
                @for (tool of tools(); track tool.id) {
                  <tr (mousedown)="selectTool(tool)"
                      [class.table-primary]="formData().toolId === tool.id"
                      style="cursor: pointer;">
                    <td>{{ tool.name }}</td>
                    <td>{{ tool.typeNumber }}</td>
                    <td>{{ tool.serialNumber }}</td>
                    <td>{{ tool.itemNumber }}</td>
                    <td>{{ tool.owner?.name }}</td>
                    <td>{{ tool.owner?.email }}</td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="6" class="text-center text-muted">Nincs elérhető gép</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </td>
    </tr>

    <!-- Hibajelenség -->
    <tr>
      <th>Hibajelenség</th>
      <td>
        <div class="d-flex align-items-center mb-2">
          <select class="form-select me-2"
                  [ngModel]="selectedDefect()"
                  (ngModelChange)="selectedDefect.set($event)">
            <option [ngValue]="undefined">Válassz hibát...</option>
            @for (defect of defects(); track defect.id) {
              <option [ngValue]="defect.id">{{ defect.name }}</option>
            }
          </select>
          <button class="btn btn-sm btn-outline-primary" (click)="addDefect()">Hozzáadás</button>
        </div>

        <ul class="list-unstyled mb-0">
          @for (d of formData().defectIds; track d) {
            <li class="d-flex justify-content-between border-bottom py-1">
              <span>{{ getDefectName(d) }}</span>
              <button class="btn btn-sm btn-link text-danger" (click)="removeDefect(d)">Törlés</button>
            </li>
          } @empty {
            <li class="text-muted">Nincs kiválasztva hiba</li>
          }
        </ul>
      </td>
    </tr>

    <!-- Megjegyzések -->
    <tr>
      <th>Megjegyzések</th>
      <td>
        <div class="d-flex mb-2">
          <input class="form-control me-2"
                 [ngModel]="newNote()"
                 (ngModelChange)="newNote.set($event)"
                 placeholder="Új megjegyzés..."/>
          <button class="btn btn-sm btn-outline-primary" (click)="addNote()">Hozzáadás</button>
        </div>

        <ul class="list-unstyled mb-0">
          @for (note of formData().notes; track note.noteId) {
            <li class="border-bottom py-1">
              <strong>{{ note.userName }}</strong> – {{ note.noteText }}
              <small class="text-muted">({{ note.postedDate | date: 'yyyy.MM.dd HH:mm' }})</small>

              @if (authState.canDeleteComment(note.userId)) {
                <button class="btn btn-sm btn-link text-danger float-end"
                        (click)="removeNote(note.noteId)">Törlés</button>
              }
            </li>
          } @empty {
            <li class="text-muted">Nincsenek megjegyzések</li>
          }
        </ul>
      </td>
    </tr>

    <!-- Checkboxok -->
    <tr>
      <th>Garanciális adatok</th>
      <td>
        <div class="form-check">
          <input class="form-check-input" type="checkbox"
                 [checked]="formData().warranty"
                 (change)="updateField('warranty', $event.target.checked)">
          <label class="form-check-label">Garanciális</label>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox"
                 [checked]="formData().hasWarrantyCard"
                 (change)="updateField('hasWarrantyCard', $event.target.checked)">
          <label class="form-check-label">Jótállási kártya</label>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox"
                 [checked]="formData().hasInvoiceCopy"
                 (change)="updateField('hasInvoiceCopy', $event.target.checked)">
          <label class="form-check-label">Számlamásolat</label>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox"
                 [checked]="formData().hasRegistrationProof"
                 (change)="updateField('hasRegistrationProof', $event.target.checked)">
          <label class="form-check-label">Regisztrációs igazolás</label>
        </div>
      </td>
    </tr>

    <!-- Szerelő -->
    <tr>
      <th>Szerelő</th>
      <td>
        <select class="form-select"
                [ngModel]="formData().assignee"
                (ngModelChange)="updateField('assignee', $event)">
          <option [ngValue]="null">Nincs hozzárendelve</option>
          @for (user of users(); track user.id) {
            <option [ngValue]="user.id">{{ user.fullName }}</option>
          }
        </select>
      </td>
    </tr>
    </tbody>
  </table>

  <!-- Mentés gomb -->
  <div class="text-end mt-3">
    <button class="btn btn-primary" (click)="createWorksheet()">Mentés</button>
  </div>
</div>
