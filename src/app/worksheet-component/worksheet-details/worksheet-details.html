<div class="container mt-4">

  @if (error()) {
    <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center justify-content-between mt-3" role="alert">
      <div class="me-2">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ error() }}
      </div>
      <button type="button" class="btn-close" aria-label="Bez√°r√°s" (click)="error.set(null)"></button>
    </div>
  }

  @if (formData(); as fd) {
    <h3 class="mb-4 text-center">üß∞ Jav√≠t√°sra beadott g√©p adatai</h3>

    <!-- G√©p adatok -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">G√©p alapadatai</div>
      <div class="card-body p-0">
        <table class="table table-bordered mb-0 align-middle">
          <thead class="table-light">
          <tr>
            <th>Megnevez√©s</th>
            <th>T√≠pus sz√°m</th>
            <th>Cikksz√°m</th>
            <th>Sorsz√°m</th>
            <th>√Åtv√©tel id≈ëpontja</th>
            <th>Tulajdonos neve</th>
            <th>C√©g</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>{{ worksheet()?.tool?.name }}</td>
            <td>{{ worksheet()?.tool?.typeNumber }}</td>
            <td>{{ worksheet()?.tool?.itemNumber }}</td>
            <td>{{ worksheet()?.tool?.serialNumber }}</td>
            <td>{{ worksheet()?.createdAt | date:'yyyy.MM.dd HH:mm:ss' }}</td>
            <td>{{ worksheet()?.tool?.ownerName }}</td>
            <td>{{ worksheet()?.tool?.ownerCompanyName }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Szerel≈ë -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">Szerel≈ë kijel√∂l√©se</div>
      <div class="card-body">
        <select class="form-select w-auto"
                [ngModel]="formData().assignee"
                (ngModelChange)="setAssignee($event)">
          @for (user of users(); track user.id) {
            <option [ngValue]="user.id">{{ user.fullName }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Hibajelens√©gek -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">Hibajelens√©gek</div>
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <select class="form-select me-2"
                  [ngModel]="selectedDefect()"
                  (ngModelChange)="selectedDefect.set($event)">
            <option [ngValue]="undefined">V√°lassz hib√°t...</option>
            @for (defect of defectsActive(); track defect.id) {
              <option [ngValue]="defect.id">{{ defect.name }}</option>
            }
          </select>
          <button class="btn btn-sm btn-outline-primary" (click)="addDefect()">Hozz√°ad√°s</button>
        </div>

        <ul class="list-group">
          @for (d of fd.defectIds; track d) {
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ getDefectName(d) }}
              <button class="btn btn-sm btn-link text-danger" (click)="removeDefect(d)">T√∂rl√©s</button>
            </li>
          } @empty {
            <li class="list-group-item text-muted text-center">Nincs kiv√°lasztva hiba</li>
          }
        </ul>
      </div>
    </div>

    <!-- Megjegyz√©sek -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">Megjegyz√©sek</div>
      <div class="card-body">
        <div class="d-flex mb-2">
          <input class="form-control me-2"
                 [ngModel]="newNote()"
                 (ngModelChange)="newNote.set($event)"
                 placeholder="√öj megjegyz√©s..."/>
          <button class="btn btn-sm btn-outline-primary" (click)="addNote()">Hozz√°ad√°s</button>
        </div>

        <ul class="list-group">
          @for (note of fd.notes; track note.noteId) {
            <li class="list-group-item">
              <strong>{{ note.userName }}</strong> ‚Äì {{ note.noteText }}
              <small class="text-muted">({{ note.postedDate | date:'yyyy.MM.dd HH:mm' }})</small>

              @if (authState.canDeleteComment(note.userId)) {
                <button class="btn btn-sm btn-link text-danger float-end"
                        (click)="removeNote(note.noteId)">T√∂rl√©s</button>
              }
            </li>
          } @empty {
            <li class="list-group-item text-muted text-center">Nincsenek megjegyz√©sek</li>
          }
        </ul>
      </div>
    </div>

    <!-- Checkboxok -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">Garanci√°lis adatok</div>
      <div class="card-body">
        <div class="form-check mb-2">
          <input type="checkbox" class="form-check-input" [(ngModel)]="fd.isWarranty" id="w1">
          <label for="w1" class="form-check-label">Garanci√°lis a g√©p?</label>
        </div>

        <div class="form-check mb-2">
          <input type="checkbox" class="form-check-input" [(ngModel)]="fd.hasWarrantyCard" id="w2">
          <label for="w2" class="form-check-label">Behozta a j√≥t√°ll√°si jegyet?</label>
        </div>

        <div class="form-check mb-2">
          <input type="checkbox" class="form-check-input" [(ngModel)]="fd.hasInvoiceCopy" id="w3">
          <label for="w3" class="form-check-label">Behozta a sz√°mlam√°solatot?</label>
        </div>

        <div class="form-check">
          <input type="checkbox" class="form-check-input" [(ngModel)]="fd.hasRegistrationProof" id="w4">
          <label for="w4" class="form-check-label">Behozta a regisztr√°ci√≥s igazol√°st?</label>
        </div>
      </div>
    </div>

    <!-- St√°tusz -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">St√°tusz</div>
      <div class="card-body">
        <select class="form-select w-auto" [(ngModel)]="fd.status">
          @for (s of statusOptions; track s) {
            <option [value]="s">{{ s }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Alkatr√©szek -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold bg-light">Sz√ºks√©ges alkatr√©szek</div>

      <div class="card-body">
        <!-- Keres≈ëmez≈ë -->
        <input type="text"
               class="form-control mb-2"
               placeholder="Alkatr√©sz keres√©se..."
               [ngModel]="searchTerm()"
               (ngModelChange)="filterSpareParts($event)"
               (focus)="dropdownOpen.set(true)"
               (blur)="closeDropdownOnBlur()" />

        <!-- T√°bl√°zatos leg√∂rd√ºl≈ë lista -->
        @if (dropdownOpen() && filteredSpareParts().length > 0) {
          <div class="dropdown-menu show w-100 p-0 mt-1 shadow-sm"
               style="max-height: 250px; overflow-y: auto; z-index: 1050;">

            <table class="table table-hover table-sm mb-0 align-middle">
              <thead class="table-light sticky-top">
              <tr>
                <th>Megnevez√©s</th>
                <th>Cikksz√°m</th>
                <th>Nett√≥ √°r</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
                @for (sparePart of filteredSpareParts() | slice:0:8; track sparePart.id) {
                  <tr (mousedown)="setSelectedSparePart(sparePart)"
                      style="cursor: pointer;">
                    <td>{{ sparePart.itemName }}</td>
                    <td>{{ sparePart.itemNumber }}</td>
                    <td>{{ sparePart.nettoSellingPrice | number:'1.0-0' }} Ft</td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="5" class="text-center text-muted">
                      Nincs tal√°lat
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        <!-- Hozz√°ad√°s gomb -->
        <button class="btn btn-sm btn-outline-primary mt-2"
                (click)="addSpareParts()">Hozz√°ad√°s</button>
      </div>
    </div>


        <table class="table table-striped table-sm mt-3">
          <thead class="table-light">
          <tr>
            <th>Megnevez√©s</th>
            <th>Cikksz√°m</th>
            <th>Nett√≥ √°r</th>
            <th>Darabsz√°m</th>
            <th>√ñsszesen</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
            @for (part of fd.spareParts; track part.sparePart.id; let i = $index) {
              <tr>
                <td>{{ part.sparePart.itemName }}</td>
                <td>{{ part.sparePart.itemNumber }}</td>
                <td>{{ part.sparePart.nettoSellingPrice | number:'1.0-0' }} Ft</td>
                <td><input type="number" class="form-control" [ngModel]="part.quantity" (ngModelChange)="updateQuantity(i, $event)"></td>
                <td>{{ (part.sparePart.nettoSellingPrice ?? 0) * (part.quantity ?? 0) | number:'1.0-0' }} Ft</td>
                <td><button class="btn btn-sm btn-danger" (click)="removeSparePart(i)">üóë</button></td>
              </tr>
            } @empty {
              <tr><td colspan="6" class="text-center text-muted">Nincsenek alkatr√©szek</td></tr>
            }
          </tbody>
        </table>

        <div class="text-end mt-3">
          <p class="fw-bold fs-5 mb-1">
            Jav√≠t√°s teljes NETT√ì √∂sszege:
            <span class="text">{{ totalGrossNetto() | number:'1.0-0' }} Ft</span>
          </p>
          <p class="fw-bold fs-5">
            Jav√≠t√°s teljes BRUTT√ì √∂sszege:
            <span class="text">{{ totalGrossNetto() * 1.27 | number:'1.0-0' }} Ft</span>
          </p>
        </div>

    <!-- Ment√©s -->
    <div class="text-end mt-4">
      <button class="btn btn-primary btn-lg" (click)="save()">üíæ Szerkeszt√©s befejez√©se √©s ment√©s</button>
    </div>
  } @else {
    <div class="alert alert-info text-center py-4">Bet√∂lt√©s folyamatban...</div>
  }
</div>
