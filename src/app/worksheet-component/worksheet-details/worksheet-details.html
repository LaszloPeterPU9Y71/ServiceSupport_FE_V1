<div class="container mt-4">
  @if (formData(); as fd) {
    <h3 class="mb-4">Jav√≠t√°sra beadott g√©p adatai</h3>
    <table class="table table-bordered">
      <thead>
      <tr>
        <th>Megnevez√©s</th>
        <th>T√≠pus sz√°m</th>
        <th>Cikksz√°m</th>
        <th>Sorsz√°m</th>
        <th>√Åtv√©tel id≈ëpontja</th>
        <th>Tulajdonos neve</th>
        <th>C√©g</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>{{ worksheet()?.tool?.name }}</td>
        <td>{{ worksheet()?.tool?.typeNumber }}</td>
        <td>{{ worksheet()?.tool?.itemNumber }}</td>
        <td>{{ worksheet()?.tool?.serialNumber }}</td>
        <td>{{ worksheet()?.createdAt | date:'yyyy.MM.dd HH:mm:ss' }}</td>
        <td>{{ worksheet()?.tool?.ownerName }}</td>
        <td>{{ worksheet()?.tool?.ownerCompanyName }}</td>
      </tr>
      </tbody>
    </table>

    <h4>Szerel≈ë:</h4>

    <select class="form-select w-auto"
            [ngModel]="formData().assignee"
            (ngModelChange)="setAssignee($event)">
      @for (user of users(); track user.id) {
        <option [ngValue]="user.id">
          {{ user.fullName }}
        </option>
      }
    </select>

    <!-- Hibajelens√©gek -->
    <div class="mb-3">
      <h5>Hibajelens√©g</h5>
      <select class="form-select mb-2"
              [ngModel]="selectedDefect()"
              (ngModelChange)="selectedDefect.set($event)">
        <option [ngValue]="undefined">V√°lassz hib√°t...</option>
        @for (defect of defects(); track defect.id) {
          <option [ngValue]="defect.id">{{ defect.name }}</option>
        }
      </select>

      <button class="btn btn-sm btn-outline-primary" (click)="addDefect()">Hozz√°ad√°s</button>

      <ul class="mt-2">
        @for (d of fd.defectIds; track d) {
          <li>
            {{ getDefectName(d) }}
            <button class="btn btn-sm btn-link text-danger" (click)="removeDefect(d)">T√∂rl√©s</button>
          </li>
        } @empty {
          <li class="text-muted">Nincs kiv√°lasztva hiba</li>
        }
      </ul>
    </div>

    <!-- Megjegyz√©sek -->
    <div class="mb-3">
      <h5>Megjegyz√©sek</h5>
      <input class="form-control mb-2"
             [ngModel]="newNote()"
             (ngModelChange)="newNote.set($event)"
             placeholder="√öj megjegyz√©s..."/>

      <button class="btn btn-sm btn-outline-primary" (click)="addNote()">Hozz√°ad√°s</button>

      <ul class="mt-2">
        @for (note of fd.notes; track note.noteId) {
          <li>
            <strong>{{ note.userName }}</strong> ‚Äì {{ note.noteText }} ‚Äì {{ note.postedDate | date: 'yyyy.MM.dd HH:mm' }}
            @if (authState.canDeleteComment(note.userId)) {
              <button class="btn btn-sm btn-link text-danger" (click)="removeNote(note.noteId)">T√∂rl√©s</button>
            }
          </li>
        } @empty {
          <li class="text-muted">Nincsenek megjegyz√©sek</li>
        }
      </ul>
    </div>

    <!-- Checkboxok -->
    <div class="mb-3">
      <p><input type="checkbox" [(ngModel)]="fd.isWarranty"> Garanci√°lis a g√©p?</p>
      <p><input type="checkbox" [(ngModel)]="fd.hasWarrantyCard"> Behozta a j√≥t√°ll√°si jegyet?</p>
      <p><input type="checkbox" [(ngModel)]="fd.hasInvoiceCopy"> Behozta a sz√°mlam√°solatot?</p>
      <p><input type="checkbox" [(ngModel)]="fd.hasRegistrationProof"> Behozta a regisztr√°ci√≥s igazol√°st?</p>
    </div>

    <!-- St√°tusz -->
    <div class="mb-3">
      <label class="form-label"><strong>A g√©p st√°tusza:</strong></label>
      <select class="form-select" [(ngModel)]="fd.status">
        @for (s of statusOptions; track s) {
          <option [value]="s">{{ s }}</option>
        }
      </select>
    </div>

    <!-- Alkatr√©szek -->
    <div class="mb-3">
      <div class="mb-3 position-relative">
        <h5>Sz√ºks√©ges alkatr√©szek</h5>

        <!-- keres≈ëmez≈ë -->
        <input type="text"
               class="form-control mb-2"
               placeholder="Alkatr√©sz keres√©se..."
               [ngModel]="searchTerm()"
               (ngModelChange)="filterSpareParts($event)"
               (focus)="dropdownOpen.set(true)"
               (blur)="closeDropdownOnBlur()" />

        <!-- dropdown lista -->
        @if (dropdownOpen() && filteredSpareParts().length > 0) {
          <div class="dropdown-menu show w-100"
               style="max-height: 200px; overflow-y: auto;">
            @for (sparePart of filteredSpareParts() | slice:0:8; track sparePart.id) {
              <button class="dropdown-item"
                      (click)="setSelectedSparePart(sparePart)">
                {{ sparePart.itemName }} ({{ sparePart.itemNumber }})
                ‚Äì {{ sparePart.nettoSellingPrice }} Ft
              </button>
            }
          </div>
        }

        <!-- hozz√°ad√°s gomb -->
        <button class="btn btn-sm btn-outline-primary mt-2"
                (click)="addSpareParts()">Hozz√°ad√°s</button>
      </div>

      <table class="table table-striped table-sm">
        <thead>
        <tr>
          <th>Megnevez√©s</th>
          <th>Cikksz√°m</th>
          <th>Nett√≥ √°r</th>
          <th>Darabsz√°m</th>
          <th>√ñsszesen</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
          @for (part of fd.spareParts; track part.sparePart.id; let i = $index) {
            <tr>
              <td>{{ part.sparePart.itemName }}</td>
              <td>{{ part.sparePart.itemNumber }}</td>
              <td>{{ part.sparePart.nettoSellingPrice | number:'1.0-0' }} Ft</td>
              <td>
                <input type="number" class="form-control"
                       [ngModel]="part.quantity"
                       (ngModelChange)="updateQuantity(i, $event)">
              </td>
              <td>{{ (part.sparePart.nettoSellingPrice ?? 0) * (part.quantity ?? 0) | number:'1.0-0' }} Ft</td>
              <td>
                <button class="btn btn-sm btn-danger" (click)="removeSparePart(i)">üóë</button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="text-muted text-center">Nincsenek alkatr√©szek</td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Teljes √∂sszeg -->
      <p class="text-end fw-bold fs-5 mt-3">
        Jav√≠t√°s teljes NETT√ì √∂sszege:
        <span class="text-success">{{ totalGross() | number:'1.0-0' }} Ft</span>
      </p>
      <p class="text-end fw-bold fs-5 mt-3">
        Jav√≠t√°s teljes BRUTT√ì √∂sszege:
        <span class="text-success">{{ totalGross() * 1.27 | number:'1.0-0' }} Ft</span>

      </p>
    </div>

    <!-- Ment√©s -->
    <div class="text-end mt-3">
      <button class="btn btn-primary" (click)="save()">Szerkeszt√©s befejez√©se √©s ment√©s</button>
    </div>
  } @else {
    <div class="alert alert-info">Bet√∂lt√©s folyamatban...</div>
  }
</div>
